<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento de Ventas - SIIGO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
    .container { max-width: 1000px; margin: 40px auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0px 4px 12px rgba(0,0,0,0.1);}
    h2 { text-align: center; color: #0056b3; margin-bottom: 20px;}
    label { font-weight: bold; display: block; margin-top: 15px; color: #333;}
    input, textarea, select { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;}
    textarea { resize: vertical; min-height: 80px;}
    button { margin-top: 10px; padding: 8px 12px; border: none; border-radius: 6px; background: #0056b3; color: white; font-size: 14px; cursor: pointer;}
    button:hover { background: #00408f;}
    .footer { text-align: center; margin-top: 25px; font-size: 12px; color: #666;}
    table { width: 100%; border-collapse: collapse; margin-top: 25px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 13px; }
    th { background: #0056b3; color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    .filtro { margin-top: 20px; padding: 10px; background: #eef3fa; border-radius: 8px; }
  </style>
</head>
<body>

  <div class="container">
    <h2>Formulario Ejecutivo de Ventas - SIIGO</h2>

    <form id="ventasForm">
      <label>üßæ C√©dula del vendedor:</label>
      <input type="text" id="cedula_vendedor" placeholder="Ej: 1234567890" oninput="guardarCedula()">

      <label>A qu√© se dedica la empresa:</label>
      <input type="text" id="actividad_empresa">

      <label>Nombre del contacto:</label>
      <input type="text" id="nombre_contacto">

      <label>Rol en la empresa:</label>
      <input type="text" id="rol_contacto">

      <label>¬øC√≥mo trabajas hoy en d√≠a la contabilidad?</label>
      <textarea id="contabilidad"></textarea>

      <label>¬øQu√© necesidad tienes?</label>
      <textarea id="necesidad"></textarea>

      <label>Producto cotizado:</label>
      <input type="text" id="producto">

      <label>¬øDe qu√© depende la compra?</label>
      <textarea id="decision_compra"></textarea>

      <label>No olvides solicitar referidos:</label>
      <input type="text" id="referidos">

      <label>Observaciones o comentarios adicionales (opcional):</label>
      <textarea id="observaciones"></textarea>

      <label>üìÖ Fecha de seguimiento:</label>
      <input type="date" id="fecha_seguimiento">

      <button type="button" onclick="guardarInformacion()">Guardar Informaci√≥n</button>
    </form>

    <div class="filtro">
      <label>üîç Buscar por c√©dula de vendedor:</label>
      <input type="text" id="buscarCedula" placeholder="Escribe la c√©dula del vendedor..." oninput="filtrarPorCedula()">
    </div>

    <h3 style="margin-top:20px;">üìä Hist√≥rico de Clientes</h3>
    <table id="tablaClientes">
      <thead>
        <tr>
          <th>C√©dula</th>
          <th>Nombre</th>
          <th>Empresa</th>
          <th>Rol</th>
          <th>Necesidad</th>
          <th>Producto</th>
          <th>Recomendaci√≥n</th>
          <th>Fecha guardado</th>
          <th>Seguimiento</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="exportarExcel()">üì• Exportar a Excel</button>

    <div class="footer">Creado para uso de Ejecutivos de Ventas - SIIGO</div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0GaKJKOIIc6UNo9IFMNCX-uNn3wqNHHk",
      authDomain: "seguimiento-ventas-a415c.firebaseapp.com",
      projectId: "seguimiento-ventas-a415c",
      storageBucket: "seguimiento-ventas-a415c.firebasestorage.app",
      messagingSenderId: "57921371203",
      appId: "1:57921371203:web:41ea8a91f52b18c59ca8f6",
      measurementId: "G-D0TBJ88NN6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let historicoClientes = [];

    // Escucha en tiempo real
    onSnapshot(collection(db, "clientes"), (snapshot) => {
      historicoClientes = [];
      snapshot.forEach(docSnap => {
        let data = docSnap.data();
        data.id = docSnap.id;
        historicoClientes.push(data);
      });
      mostrarTabla(historicoClientes);
      revisarSeguimientos();
    });

    // Guardar c√©dula
    window.onload = function() {
      let cedulaGuardada = localStorage.getItem("cedulaVendedor");
      if (cedulaGuardada) document.getElementById("cedula_vendedor").value = cedulaGuardada;
    };

    window.guardarCedula = function() {
      let cedula = document.getElementById("cedula_vendedor").value;
      localStorage.setItem("cedulaVendedor", cedula);
    };

    // Guardar informaci√≥n
    window.guardarInformacion = async function() {
      const cedula = document.getElementById("cedula_vendedor").value;
      const actividad = document.getElementById("actividad_empresa").value;
      const nombre = document.getElementById("nombre_contacto").value;
      const rol = document.getElementById("rol_contacto").value;
      const contabilidad = document.getElementById("contabilidad").value;
      const necesidad = document.getElementById("necesidad").value.toLowerCase();
      const producto = document.getElementById("producto").value;
      const decision = document.getElementById("decision_compra").value;
      const referidos = document.getElementById("referidos").value;
      const observaciones = document.getElementById("observaciones").value;
      const fechaSeguimiento = document.getElementById("fecha_seguimiento").value;
      const fechaGuardado = new Date().toLocaleString();

      let recomendacion = "SIIGO Pyme/Emprendedor";
      if (necesidad.includes("n√≥mina") || necesidad.includes("empleados")) recomendacion = "SIIGO N√≥mina";
      else if (rol.toLowerCase().includes("contador")) recomendacion = "SIIGO Contador";
      else if (necesidad.includes("erp") || necesidad.includes("inventario")) recomendacion = "SIIGO ERP Integral";

      const registro = {
        Cedula: cedula,
        Nombre: nombre,
        Empresa: actividad,
        Rol: rol,
        Necesidad: necesidad,
        Producto: producto,
        Recomendacion: recomendacion,
        FechaGuardado: fechaGuardado,
        FechaSeguimiento: fechaSeguimiento,
        Estado: "Pendiente"
      };

      try {
        await addDoc(collection(db, "clientes"), registro);
        alert("‚úÖ Informaci√≥n guardada correctamente en la nube");
      } catch (err) {
        alert("‚ùå Error al guardar: " + err.message);
      }
    };

    // Mostrar tabla
    function mostrarTabla(datos) {
      const tabla = document.getElementById("tablaClientes").getElementsByTagName('tbody')[0];
      tabla.innerHTML = "";
      datos.forEach((r) => {
        const fila = tabla.insertRow();
        fila.insertCell(0).innerText = r.Cedula;
        fila.insertCell(1).innerText = r.Nombre;
        fila.insertCell(2).innerText = r.Empresa;
        fila.insertCell(3).innerText = r.Rol;
        fila.insertCell(4).innerText = r.Necesidad;
        fila.insertCell(5).innerText = r.Producto;
        fila.insertCell(6).innerText = r.Recomendacion;
        fila.insertCell(7).innerText = r.FechaGuardado;
        fila.insertCell(8).innerText = r.FechaSeguimiento;

        const celdaEstado = fila.insertCell(9);
        const selectEstado = document.createElement("select");
        const opciones = ["Pendiente", "Seguimiento", "Venta", "No acepta Venta"];
        opciones.forEach(op => {
          const option = document.createElement("option");
          option.value = op;
          option.textContent = op;
          if (r.Estado === op) option.selected = true;
          selectEstado.appendChild(option);
        });
        selectEstado.addEventListener("change", async () => {
          const nuevoEstado = selectEstado.value;
          await updateDoc(doc(db, "clientes", r.id), { Estado: nuevoEstado });
          alert(`‚úÖ Estado actualizado a: ${nuevoEstado} para ${r.Nombre}`);
        });
        celdaEstado.appendChild(selectEstado);
      });
    }

    // Filtro por c√©dula
    window.filtrarPorCedula = function() {
      const filtro = document.getElementById("buscarCedula").value.trim();
      if (filtro === "") {
        mostrarTabla(historicoClientes);
      } else {
        const filtrados = historicoClientes.filter(c => c.Cedula && c.Cedula.includes(filtro));
        mostrarTabla(filtrados);
      }
    };

    // Revisar seguimientos
    function revisarSeguimientos() {
      const hoy = new Date().toISOString().split("T")[0];
      historicoClientes.forEach(c => {
        if (c.Estado === "Pendiente" && c.FechaSeguimiento && c.FechaSeguimiento <= hoy) {
          alert("‚ö†Ô∏è Seguimiento pendiente o vencido: " + c.Nombre + " (" + c.Empresa + ")");
        }
      });
    }

    // Exportar a Excel
    window.exportarExcel = function() {
      const ws = XLSX.utils.json_to_sheet(historicoClientes);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Clientes");
      XLSX.writeFile(wb, "Historico_Clientes_SIIGO.xlsx");
    };
  </script>
</body>
</html>
