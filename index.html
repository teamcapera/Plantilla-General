<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seguimiento de Ventas - SIIGO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
    .container { max-width: 1000px; margin: 32px auto; background: #fff; padding: 22px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);}
    h2 { text-align: center; color: #0056b3; margin-bottom: 12px;}
    label { font-weight: bold; display:block; margin-top:12px; color:#333; }
    input[type="text"], input[type="date"], textarea, select {
      width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;
    }
    textarea { min-height:80px; resize:vertical; }
    button { margin-top:12px; padding:10px 14px; border:none; border-radius:8px; background:#0056b3; color:#fff; cursor:pointer; }
    button:hover { background:#00408f; }
    .filtro { margin-top:18px; padding:10px; background:#eef3fa; border-radius:8px; display:flex; gap:10px; align-items:center; }
    .filtro input { flex:1; }
    .clear-btn { background:#dc3545; color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; }
    .clear-btn:hover{ background:#a71d2a; }
    table { width:100%; border-collapse:collapse; margin-top:18px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; font-size:13px; }
    th { background:#0056b3; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9; }
    .autocomplete-wrap { position: relative; }
    .suggestions {
      position:absolute; left:0; right:0; z-index:50; background:#fff; border:1px solid #ccc; border-top:none; max-height:200px; overflow:auto;
      border-bottom-left-radius:6px; border-bottom-right-radius:6px;
    }
    .suggestion-item { padding:8px 10px; cursor:pointer; }
    .suggestion-item:hover, .suggestion-item.active { background:#f0f4f9; }
    .small { font-size:12px; color:#666; margin-left:6px; }
    .ver-mas { background:#007bff; margin-top:12px; padding:10px 14px; color:#fff; border:none; border-radius:8px; cursor:pointer; }
    .ver-mas:hover { background:#0056b3; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Formulario Ejecutivo de Ventas - SIIGO</h2>

    <form id="ventasForm" onsubmit="return false;">
      <label>🧾 Cédula del vendedor:</label>
      <input type="text" id="cedula_vendedor" placeholder="Ej: 1234567890" oninput="guardarCedula()" />

      <label>A qué se dedica la empresa:</label>
      <input type="text" id="actividad_empresa" />

      <label>Nombre del contacto:</label>
      <input type="text" id="nombre_contacto" />

      <label>Rol en la empresa:</label>
      <input type="text" id="rol_contacto" />

      <label>¿Cómo trabajas hoy en día la contabilidad?</label>
      <textarea id="contabilidad"></textarea>

      <label>¿Qué necesidad tienes?</label>
      <textarea id="necesidad"></textarea>

      <label>Producto cotizado:</label>
      <div class="autocomplete-wrap">
        <input type="text" id="producto_search" placeholder="Escribe para buscar producto (elige de la lista)" autocomplete="off" />
        <div id="suggestions" class="suggestions" style="display:none;"></div>
      </div>
      <!-- Hidden field that stores the validated product value (must match one of the options) -->
      <input type="hidden" id="producto" />

      <label>¿De qué depende la compra?</label>
      <textarea id="decision_compra"></textarea>

      <label>No olvides solicitar referidos:</label>
      <input type="text" id="referidos" />

      <label>Observaciones o comentarios adicionales (opcional):</label>
      <textarea id="observaciones"></textarea>

      <label>📅 Fecha de seguimiento:</label>
      <input type="date" id="fecha_seguimiento" />

      <button type="button" onclick="guardarInformacion()">Guardar Información</button>
      <div class="small">Nota: solo se permite seleccionar productos existentes de la oferta. Si el texto no aparece en la lista, no podrá ser guardado.</div>
    </form>

    <div class="filtro">
      <label style="margin:0;">🔍 Buscar por cédula de vendedor:</label>
      <input type="text" id="buscarCedula" placeholder="Escribe la cédula..." oninput="filtrarPorCedula()" />
      <button class="clear-btn" onclick="limpiarFiltro()">Limpiar</button>
    </div>

    <h3 style="margin-top:12px;">📊 Histórico de Clientes</h3>
    <table id="tablaClientes">
      <thead>
        <tr>
          <th>Cédula</th><th>Nombre</th><th>Empresa</th><th>Rol</th><th>Necesidad</th><th>Producto</th><th>Recomendación</th><th>Fecha guardado</th><th>Seguimiento</th><th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="ver-mas" id="btnVerMas" onclick="verMas()">Ver más clientes</button>
    <button onclick="exportarExcel()">📥 Exportar a Excel</button>

    <div class="footer">Creado para uso de Ejecutivos de Ventas - SIIGO</div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0GaKJKOIIc6UNo9IFMNCX-uNn3wqNHHk",
      authDomain: "seguimiento-ventas-a415c.firebaseapp.com",
      projectId: "seguimiento-ventas-a415c",
      storageBucket: "seguimiento-ventas-a415c.firebasestorage.app",
      messagingSenderId: "57921371203",
      appId: "1:57921371203:web:41ea8a91f52b18c59ca8f6",
      measurementId: "G-D0TBJ88NN6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // PRODUCTS - lista oficial SIIGO (sin alianzas externas)
    const PRODUCTS = [
      "Facturación Electrónica 24",
      "Facturación Electrónica 120",
      "Facturación Electrónica PRO (500 Docs)",
      "Facturación Electrónica 1500 Docs",
      "Combo FE + WhatsApp 24",
      "Combo FE + WhatsApp 120",
      "Nómina Electrónica 24",
      "Nómina Electrónica 120",
      "Nómina Electrónica 300",
      "POS Web Esencial",
      "POS Web Inicio",
      "Nómina + POS Esencial",
      "Nómina + POS Inicio",
      "Combo Facturación + Nómina Electrónica",
      "Combo Facturación + Nómina + POS"
    ];

    // autocomplete elements
    const productoInput = document.getElementById("producto_search");
    const suggestionsBox = document.getElementById("suggestions");
    const hiddenProducto = document.getElementById("producto");

    let selectedIndex = -1;
    let currentSuggestions = [];

    function showSuggestions(list) {
      suggestionsBox.innerHTML = "";
      if (!list.length) { suggestionsBox.style.display = "none"; return; }
      list.forEach((item, idx) => {
        const div = document.createElement("div");
        div.textContent = item;
        div.className = "suggestion-item";
        div.dataset.value = item;
        div.addEventListener("click", () => {
          selectProduct(item);
        });
        suggestionsBox.appendChild(div);
      });
      suggestionsBox.style.display = "block";
    }

    function filterProducts(query) {
      if (!query) return PRODUCTS.slice();
      const q = query.trim().toLowerCase();
      return PRODUCTS.filter(p => p.toLowerCase().includes(q));
    }

    function selectProduct(value) {
      productoInput.value = value;
      hiddenProducto.value = value;
      suggestionsBox.style.display = "none";
      selectedIndex = -1;
      currentSuggestions = [];
    }

    productoInput.addEventListener("input", (e) => {
      const val = e.target.value;
      const list = filterProducts(val);
      currentSuggestions = list;
      selectedIndex = -1;
      showSuggestions(list);
      // clear hidden if input doesn't match exactly
      if (PRODUCTS.indexOf(val) === -1) hiddenProducto.value = "";
      else hiddenProducto.value = val;
    });

    productoInput.addEventListener("keydown", (e) => {
      if (suggestionsBox.style.display === "none") return;
      if (e.key === "ArrowDown") {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
        highlightSuggestion();
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, 0);
        highlightSuggestion();
      } else if (e.key === "Enter") {
        e.preventDefault();
        if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
          selectProduct(currentSuggestions[selectedIndex]);
        } else {
          if (PRODUCTS.indexOf(productoInput.value) !== -1) {
            hiddenProducto.value = productoInput.value;
            suggestionsBox.style.display = "none";
          }
        }
      } else if (e.key === "Escape") {
        suggestionsBox.style.display = "none";
      }
    });

    function highlightSuggestion() {
      const items = suggestionsBox.querySelectorAll(".suggestion-item");
      items.forEach((it, i) => {
        it.classList.toggle("active", i === selectedIndex);
      });
      if (selectedIndex >= 0) {
        const active = items[selectedIndex];
        if (active) active.scrollIntoView({ block: "nearest" });
      }
    }

    // click outside closes suggestions
    document.addEventListener("click", (e) => {
      if (!document.querySelector(".autocomplete-wrap").contains(e.target)) {
        suggestionsBox.style.display = "none";
      }
    });

    // FIRESTORE sync and UI logic
    let historicoClientes = [];
    let clientesMostrados = 10;

    onSnapshot(collection(db, "clientes"), (snapshot) => {
      historicoClientes = [];
      snapshot.forEach(docSnap => {
        let data = docSnap.data();
        data.id = docSnap.id;
        historicoClientes.push(data);
      });
      aplicarFiltroInicial();
      revisarSeguimientos();
    });

    window.onload = function() {
      let cedulaGuardada = localStorage.getItem("cedulaVendedor");
      if (cedulaGuardada) document.getElementById("cedula_vendedor").value = cedulaGuardada;
    };

    window.guardarCedula = function() {
      let cedula = document.getElementById("cedula_vendedor").value;
      localStorage.setItem("cedulaVendedor", cedula);
      aplicarFiltroInicial();
    };

    window.guardarInformacion = async function() {
      // validate product selected
      const productoVal = hiddenProducto.value;
      if (!productoVal) {
        alert("❗ Debes seleccionar un producto válido de la lista antes de guardar.");
        productoInput.focus();
        return;
      }

      const cedula = document.getElementById("cedula_vendedor").value;
      const actividad = document.getElementById("actividad_empresa").value;
      const nombre = document.getElementById("nombre_contacto").value;
      const rol = document.getElementById("rol_contacto").value;
      const contabilidad = document.getElementById("contabilidad").value;
      const necesidad = document.getElementById("necesidad").value.toLowerCase();
      const producto = productoVal;
      const decision = document.getElementById("decision_compra").value;
      const referidos = document.getElementById("referidos").value;
      const observaciones = document.getElementById("observaciones").value;
      const fechaSeguimiento = document.getElementById("fecha_seguimiento").value;
      const fechaGuardado = new Date().toLocaleString();

      let recomendacion = "SIIGO Pyme/Emprendedor";
      if (necesidad.includes("nómina") || necesidad.includes("empleados")) recomendacion = "SIIGO Nómina";
      else if (rol.toLowerCase().includes("contador")) recomendacion = "SIIGO Contador";
      else if (necesidad.includes("erp") || necesidad.includes("inventario")) recomendacion = "SIIGO ERP Integral";

      const registro = {
        Cedula: cedula,
        Nombre: nombre,
        Empresa: actividad,
        Rol: rol,
        Necesidad: necesidad,
        Producto: producto,
        Recomendacion: recomendacion,
        FechaGuardado: fechaGuardado,
        FechaSeguimiento: fechaSeguimiento,
        Estado: "Pendiente"
      };

      try {
        await addDoc(collection(db, "clientes"), registro);
        // reset product hidden to require new valid selection on next entry
        hiddenProducto.value = "";
        productoInput.value = "";
        alert("✅ Información guardada correctamente en la nube");
      } catch (err) {
        alert("❌ Error al guardar: " + err.message);
      }
    };

    function mostrarTabla(datos) {
      const tabla = document.getElementById("tablaClientes").getElementsByTagName('tbody')[0];
      tabla.innerHTML = "";

      const datosMostrados = datos.slice(0, clientesMostrados);
      datosMostrados.forEach((r) => {
        const fila = tabla.insertRow();
        fila.insertCell(0).innerText = r.Cedula;
        fila.insertCell(1).innerText = r.Nombre;
        fila.insertCell(2).innerText = r.Empresa;
        fila.insertCell(3).innerText = r.Rol;
        fila.insertCell(4).innerText = r.Necesidad;
        fila.insertCell(5).innerText = r.Producto;
        fila.insertCell(6).innerText = r.Recomendacion;
        fila.insertCell(7).innerText = r.FechaGuardado;
        fila.insertCell(8).innerText = r.FechaSeguimiento;

        const celdaEstado = fila.insertCell(9);
        const selectEstado = document.createElement("select");
        const opciones = ["Pendiente", "Seguimiento", "Venta", "No acepta Venta"];
        opciones.forEach(op => {
          const option = document.createElement("option");
          option.value = op;
          option.textContent = op;
          if (r.Estado === op) option.selected = true;
          selectEstado.appendChild(option);
        });
        selectEstado.addEventListener("change", async () => {
          const nuevoEstado = selectEstado.value;
          await updateDoc(doc(db, "clientes", r.id), { Estado: nuevoEstado });
          alert(`✅ Estado actualizado a: ${nuevoEstado} para ${r.Nombre}`);
        });
        celdaEstado.appendChild(selectEstado);
      });

      const btnVerMas = document.getElementById("btnVerMas");
      if (clientesMostrados >= datos.length) btnVerMas.style.display = "none";
      else btnVerMas.style.display = "block";
    }

    window.verMas = function() {
      clientesMostrados += 10;
      filtrarPorCedula();
    };

    function aplicarFiltroInicial() {
      const cedulaGuardada = localStorage.getItem("cedulaVendedor");
      if (cedulaGuardada) {
        document.getElementById("buscarCedula").value = cedulaGuardada;
        filtrarPorCedula();
      } else {
        mostrarTabla(historicoClientes);
      }
    }

    window.filtrarPorCedula = function() {
      const filtro = document.getElementById("buscarCedula").value.trim();
      clientesMostrados = 10;
      if (filtro === "") {
        mostrarTabla(historicoClientes);
      } else {
        const filtrados = historicoClientes.filter(c => c.Cedula && c.Cedula.includes(filtro));
        mostrarTabla(filtrados);
      }
    };

    window.limpiarFiltro = function() {
      document.getElementById("buscarCedula").value = "";
      clientesMostrados = 10;
      mostrarTabla(historicoClientes);
    };

    function revisarSeguimientos() {
      const hoy = new Date().toISOString().split("T")[0];
      historicoClientes.forEach(c => {
        if (c.Estado === "Pendiente" && c.FechaSeguimiento && c.FechaSeguimiento <= hoy) {
          alert("⚠️ Seguimiento pendiente o vencido: " + c.Nombre + " (" + c.Empresa + ")");
        }
      });
    }

    window.exportarExcel = function() {
      const ws = XLSX.utils.json_to_sheet(historicoClientes);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Clientes");
      XLSX.writeFile(wb, "Historico_Clientes_SIIGO.xlsx");
    };
  </script>
</body>
</html>
